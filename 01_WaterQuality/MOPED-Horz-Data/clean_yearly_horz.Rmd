1/13/2025

initial cleaning of horizontal WQ data

Title: Phycoprobe Data - Monthly Cleaning

By: Perry

```{r}
# ---
# EDIT THIS
# ---

# declare the run year of interest  
year <- 2023
```

```{r}
# ---
# CODE STARTS HERE
# ---

# import packages
library(tidyverse)
library(lubridate)
library(leaflet)
library(leaflet.extras)
library(readxl)
source('03_Phyto/phycoprobe/functions/phyco_funcs.R')

# read in run names and regions
df_names <- read_csv('03_Phyto/phycoprobe/supp_files/run_names.csv', show_col_types = FALSE)

# obtain all filepaths and create combo df
fp_all_wq <- archive_path(2023, 'MOPED')

df_combo <- create_combo_df(fp_all_wq)

df_list <- list()

# run code for all combos
for(i in 1:nrow(df_combo)){
  # define variables
  month <- df_combo[i,]$month
  run <- df_combo[i,]$run
  
  print(glue::glue('month: {month} and run: {run}'))
  
  # read in WQ data
  fp_wq <- data_path(run, month, year, type = 'MOPED')
  df_wq <- read_csv(fp_wq, skip = 2, show_col_types = FALSE)
  df_wq <- df_wq %>% filter(Equipment == 'EXO Horizontal')
  df_wq1 <- df_wq
  df_wq$TimeStamp <- parse_date_time(df_wq$TimeStamp, c('mdY HMS', 'mdY HM'))
  df_wq$TimeStamp <- as.POSIXct(df_wq$TimeStamp, format = '%m/%d/%Y %H:%M:%S')
  
  df_wq$Analyte <- paste0(df_wq$Header,'_',df_wq$Unit)

  df_wq <- df_wq %>%
    subset(select = c(Longitude, Latitude, TimeStamp, Analyte, Value)) %>%
    rename(DateTime = TimeStamp) %>%
    pivot_wider(
      names_from = Analyte,
      values_from = Value,
      values_fn = list(Value = ~ mean(.x, na.rm = TRUE)) # can look into this more
    ) %>%
    # select(-SONDEDEPTH_ft) %>%
    filter(!if_any(everything(), ~ .x == 0 | is.na(.x)))

  df_wq <- df_wq %>%
    mutate(RoundedDateTime = round_date(DateTime, 'minute')) %>%
    mutate(TimeDiff = abs(as.numeric(difftime(DateTime, RoundedDateTime, units = 'secs')))) %>%
    group_by(RoundedDateTime) %>%
    slice_min(order_by = TimeDiff, n = 1, with_ties = FALSE) %>%
    ungroup() %>%
    select(-c(DateTime, TimeDiff)) %>%
    rename(DateTime = RoundedDateTime)
  
  # filter out rows around Antioch
  lat_min <- 38.015465
  lat_max <- 38.032394
  lon_min <- -121.762379
  lon_max <- -121.741878

  df_wq <- df_wq %>%
  filter(!(Latitude >= lat_min & Latitude <= lat_max &
             Longitude >= lon_min & Longitude <= lon_max))

  # convert date/time col back to character
  df_wq$DateTime <- as.character(df_wq$DateTime)
  
  # export
  fn_exp <- str_remove(str_extract(fp_wq, '[^/]*$'), '.txt')
  
  fp_folder <- create_dir(year)
  fp_exp <- paste0(fp_folder,'/',fn_exp,'_summary.csv')
  
  # write_csv(df_final, fp_exp)

  df_list[[i]] <- df_wq
}

# Combine all dataframes into one
df_month <- bind_rows(df_list)

write_csv(df_month, 'C:/Users/sperry/Desktop/wq_test_23.csv')

write_csv(df_list[[1]], 'C:/Users/sperry/Desktop/wq_test_1month_23.csv')
```

```{r}
# create leaflet maps
df_month$DateTime <- as.POSIXct(df_month$DateTime, format = '%Y-%m-%d %H:%M:%S')

create_map <- function(df, x_col, y_col = 'DateTime') {
  leaflet(data = df) %>%
    addTiles() %>%
    addCircles(
      lng = ~Longitude, 
      lat = ~Latitude,
      color = ~colorNumeric('viridis', df[[x_col]])(df[[x_col]]),
      popup = ~paste0('<b>', x_col, ':</b> ', df[[x_col]], '<br>',
                      '<b>', y_col, ':</b> ', df[[y_col]])
    ) %>%
    addLegend('bottomright', 
              pal = colorNumeric('viridis', df[[x_col]]), 
              values = df[[x_col]],
              title = x_col,
              opacity = 1)
}

analyte_cols <- colnames(df_month)[!colnames(df_month) %in% c('Longitude', 'Latitude', 'DateTime')]

for (col in analyte_cols) {
  print(create_map(df_month, col))
}
```




